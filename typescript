import { Shield, CheckCircle, XCircle, Loader2, ExternalLink, AlertTriangle, Package, Calendar, Info } from "lucide-react";

useEffect(() => {
  // Redirect if error exists, loading is done, and no medicine data found
  if (error && !loading && !medicineData) {
      const timer = setTimeout(() => {
           navigate("/not-verified");
      }, 100);
      return () => clearTimeout(timer);
  }
}, [error, loading, medicineData, navigate]);

                        {scanResult.medicine && (
                          <div className="text-sm space-y-1 text-gray-300">
                            <p>Name: <span className="text-white">{scanResult.medicine.medicineName}</span></p>
                            <p>Batch: <span className="text-white">{scanResult.medicine.batchNumber}</span></p>
                            <p>Expiry: <span className="text-white">{scanResult.medicine.expiryDate}</span></p>
                          </div>
                        )}
// Try to find in medicine_units (unit QR)
const unit = await ctx.db
  .query("medicine_units")
  .withIndex("by_qr_code", (q) => q.eq("qrCodeData", args.qrCodeData))
  .first();

// Determine the correct Token ID to query on blockchain
// If we have medicineData, use the batch tokenId. 
// Otherwise, try to use the passed tokenId (fallback)
const blockchainTokenId = medicineData?.tokenId || tokenId;

// Medicines table - stores NFT medicine data
medicines: defineTable({
  tokenId: v.string(), // NFT token ID from blockchain (Batch ID)
  medicineName: v.string(),
  manufacturerName: v.string(),
  manufacturerId: v.id("users"),
  batchNumber: v.string(),
  medicineType: v.string(), // tablet, syrup, injection, etc.
  manufacturingDate: v.string(),
  expiryDate: v.string(),
  mrp: v.number(),
  quantity: v.number(),
  qrCodeData: v.string(), // QR code content for the batch
  transactionHash: v.string(), // Blockchain transaction hash
  contractAddress: v.string(), // Smart contract address
  isActive: v.boolean(),
})
  .index("by_manufacturer", ["manufacturerId"])
  .index("by_batch", ["batchNumber"])
  .index("by_token_id", ["tokenId"])
  .index("by_qr_code", ["qrCodeData"]),

// Individual Medicine Units
medicine_units: defineTable({
  medicineId: v.id("medicines"),
  tokenId: v.string(), // Unique Token ID for this unit
  serialNumber: v.number(), // 1 to N
  qrCodeData: v.string(), // Unique QR code content
  isVerified: v.boolean(),
  status: v.optional(v.string()), // "minted", "sold", "consumed"
})
  .index("by_medicine", ["medicineId"])
  .index("by_token_id", ["tokenId"])
  .index("by_qr_code", ["qrCodeData"]),

// Scan history - tracks all QR code scans
scanHistory: defineTable({
  qrCodeData: v.string(), // QR code content
  scanTime: v.timestamp(), // Time of scan
  userId: v.id("users"),
  medicineId: v.id("medicines"),
  status: v.optional(v.string()), // "success", "error"
})

// Get medicine by QR code data
export const getMedicineByQRCode = query({
  args: { qrCodeData: v.string() },
  handler: async (ctx, args) => {
    // Try to find in medicines (batch QR)
    const medicine = await ctx.db
      .query("medicines")
      .withIndex("by_qr_code", (q) => q.eq("qrCodeData", args.qrCodeData))
      .first();
    
    if (medicine) return medicine;

    // Try to find in medicine_units (unit QR)
    const unit = await ctx.db
      .query("medicine_units")
      .withIndex("by_qr_code", (q) => q.eq("qrCodeData", args.qrCodeData))
      .first();

    if (unit) {
      const parentMedicine = await ctx.db.get(unit.medicineId);
      if (parentMedicine) {
        return {
          ...parentMedicine,
          unit
        };
      }
    }

    return null;
  },
});

export default function Verify() {
  return (
    <div className="min-h-screen bg-gray-900 text-white">
      <header className="bg-gray-800 p-4 border-b border-gray-700">
        <div className="container mx-auto flex justify-between items-center">
          <h1 className="text-2xl font-bold">MediVerify</h1>
          <div className="flex items-center space-x-4">
            <button className="flex items-center space-x-2 text-gray-300 hover:text-white transition-colors">
              <Shield className="w-5 h-5" />
              <span>Verify</span>
            </button>
            <button className="flex items-center space-x-2 text-gray-300 hover:text-white transition-colors">
              <CheckCircle className="w-5 h-5" />
              <span>Scan</span>
            </button>
          </div>
        </div>
      </header>

      <main className="container mx-auto p-6">
        <div className="max-w-3xl mx-auto">
          <h2 className="text-3xl font-bold mb-6 text-center">Medicine Verification</h2>
          
          <div className="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
            <h3 className="text-xl font-semibold mb-4">Scan Result</h3>
            <div className="space-y-4">
              {scanResult.medicine && (
                <div className="text-sm space-y-1 text-gray-300">
                  <p><strong>Name:</strong> <span className="text-white">{scanResult.medicine.medicineName}</span></p>
                  <p><strong>Batch:</strong> <span className="text-white">{scanResult.medicine.batchNumber}</span></p>
                  <p><strong>Expiry:</strong> <span className="text-white">{scanResult.medicine.expiryDate}</span></p>
                </div>
              )}
              {scanResult.status === "success" && (
                <div className="text-green-400">
                  <CheckCircle className="w-5 h-5 inline mr-2" />
                  <span>Verification successful</span>
                </div>
              )}
              {scanResult.status === "error" && (
                <div className="text-red-400">
                  <XCircle className="w-5 h-5 inline mr-2" />
                  <span>Verification failed</span>
                </div>
              )}
            </div>
          </div>

          <div className="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
            <h3 className="text-xl font-semibold mb-4">Medicine Details</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">Medicine Name</label>
                <p className="text-white">{scanResult.medicine?.medicineName || "N/A"}</p>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">Batch Number</label>
                <p className="text-white">{scanResult.medicine?.batchNumber || "N/A"}</p>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">Expiry Date</label>
                <p className="text-white">{scanResult.medicine?.expiryDate || "N/A"}</p>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">Manufacturer</label>
                <p className="text-white">{scanResult.medicine?.manufacturerName || "N/A"}</p>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">Type</label>
                <p className="text-white">{scanResult.medicine?.medicineType || "N/A"}</p>
              </div>
            </div>
          </div>

          <div className="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
            <h3 className="text-xl font-semibold mb-4">Verification Status</h3>
            <div className="space-y-4">
              <div className="flex items-center space-x-4">
                <div className={`w-3 h-3 rounded-full ${scanResult.status === "success" ? "bg-green-400" : "bg-red-400"}`}></div>
                <p className="text-white">
                  {scanResult.status === "success" ? "Medicine is verified and safe to use" : "Medicine verification failed"}
                </p>
              </div>
              {scanResult.status === "error" && (
                <div className="text-red-400">
                  <AlertTriangle className="w-5 h-5 inline mr-2" />
                  <span>Failed to verify medicine. Please check the QR code or contact support.</span>
                </div>
              )}
            </div>
          </div>

          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 className="text-xl font-semibold mb-4">Scan History</h3>
            <div className="space-y-4">
              {scanHistory.map((entry, index) => (
                <div key={index} className="text-sm text-gray-300">
                  <p><strong>Scan {index + 1}:</strong> {entry.scanTime.toLocaleString()}</p>
                  <p className={`text-sm ${entry.status === "success" ? "text-green-400" : "text-red-400"}`}>
                    {entry.status === "success" ? "✅ Verified" : "❌ Failed"}
                  </p>
                </div>
              ))}
            </div>
          </div>
        </div>
      </main>

      <footer className="bg-gray-800 p-4 border-t border-gray-700 mt-8">
        <div className="container mx-auto text-center text-gray-400">
          <p>MediVerify &copy; {new Date().getFullYear()} - Secure Medicine Verification</p>
        </div>
      </footer>
    </div>
  );
}